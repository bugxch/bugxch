<rss xmlns:atom="http://www.w3.org/2005/Atom" version="2.0">
    <channel>
        <title>ML - 标签 - 致力于把技术要点写清楚</title>
        <link>https://bugxch.github.io/tags/ml/</link>
        <description>ML - 标签 - 致力于把技术要点写清楚</description>
        <generator>Hugo -- gohugo.io</generator><language>zh-CN</language><managingEditor>bugxch@126.com (bugxch)</managingEditor>
            <webMaster>bugxch@126.com (bugxch)</webMaster><copyright>This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.</copyright><lastBuildDate>Sat, 09 Feb 2019 19:02:24 &#43;0000</lastBuildDate><atom:link href="https://bugxch.github.io/tags/ml/" rel="self" type="application/rss+xml" /><item>
    <title>Manjaro安装CUDA教程</title>
    <link>https://bugxch.github.io/manjaro%E5%AE%89%E8%A3%85cuda%E6%95%99%E7%A8%8B/</link>
    <pubDate>Sat, 09 Feb 2019 19:02:24 &#43;0000</pubDate><author>
        <name>bugxch</name>
    </author><guid>https://bugxch.github.io/manjaro%E5%AE%89%E8%A3%85cuda%E6%95%99%E7%A8%8B/</guid>
    <description><![CDATA[<p>去年年底安装将我的Thinkpad T450的双系统中的opensuse换成了<a href="https://manjaro.org/" target="_blank" rel="noopener noreffer">Manjaro</a>，折腾安装了下CUDA，是为记录。</p>
<h2 id="基本安装">基本安装</h2>
<h3 id="nvidia显卡安装">NVIDIA显卡安装</h3>
<p>Manjaro系统安装显卡比较简单，它有一个命令</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">sudo mhwd -a <span class="o">[</span>pci or usb connection<span class="o">]</span> <span class="o">[</span>free or nonfree drivers<span class="o">]</span> <span class="m">0300</span>
</code></pre></td></tr></table>
</div>
</div><p>其中</p>
<ul>
<li><strong>-a</strong>: 自动检测和安装合适的显卡驱动</li>
<li><strong>[pci or usb]</strong>: 为通过PCI或者USB连接的设置安装驱动</li>
<li><strong>[free or nonfree]</strong>: 安装免费或者非免费的驱动</li>
<li><strong>0300</strong>: 确认即将安装的显卡的驱动</li>
</ul>
<p>我们要安装英伟达的驱动，只要使用下面的一行命令即可搞定</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">sudo mhwd -a pci nonfree <span class="m">0300</span>
</code></pre></td></tr></table>
</div>
</div><p>等待安装结束，使用如下命令查看是否已经安装完成</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">nvidia-smi
</code></pre></td></tr></table>
</div>
</div><p>我的显示结果如下</p>
<p></p>
<p>从上图可知，我的显卡型号是GeForce 940M，显卡的驱动版本是415.27。</p>
<h3 id="cuda安装">CUDA安装</h3>
<h4 id="安装命令">安装命令</h4>
<p>Manjaro的CUDA安装也是异常简单，一行命令搞定</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">sudo pacman -S cuda cudnn
</code></pre></td></tr></table>
</div>
</div><p>这行命令可能需要花费一些时间，请耐心等待。</p>
<h4 id="验证安装">验证安装</h4>
<p>完成之后，我们进入cuda的安装路径，我的路径是<code>/opt/cuda</code>，你可以使用下面的命令将CUDA的示例程序拷贝到你的用户主目录下，之后编译程序</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">cp -r /opt/cuda/samples ~
cd ~/samples
make
</code></pre></td></tr></table>
</div>
</div><p>此时就使用nvcc编译器开始编译CUDA的sample程序，这个花费时间更长，应该在半小时左右，等待编译结束，使用下面的命令验证是否成功</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="nb">cd</span> ~/samples/bin/x86_64/linux/release
./deviceQuery
</code></pre></td></tr></table>
</div>
</div><p>在窗口中查看最后一行的结果是否为pass，如果是则表示CUDA安装成功。</p>
<h2 id="双显卡配置">双显卡配置</h2>
<p>我的电脑有两个显卡，一个是intel的集成显卡，一个是NVIDIA的独显。</p>
<h3 id="安装显卡切换程序">安装显卡切换程序</h3>
<p>Manjaro的双显卡配置有点问题，Bumblebee还是有点问题，使用下面的命令重新安装</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="c1"># 依赖</span>
sudo pacman -S virtualgl lib32-virtualgl lib32-primus primus

<span class="c1"># 安装双显卡切换程序bumblebee</span>
sudo mhwd -f -i pci video-hybrid-intel-nvidia-bumblebee

<span class="c1"># 允许服务</span>
sudo systemctl <span class="nb">enable</span> bumblebeed

<span class="c1"># 添加用户</span>
sudo gpasswd -a <span class="nv">$USER</span> bumblebee
</code></pre></td></tr></table>
</div>
</div><p>为了防止重启之后不能进入登录界面，需要做如下的配置</p>
<ol>
<li>打开 /etc/default/grub</li>
<li>找到并且改为：GRUB_CMLINE_LINUX_DEFAULT=&ldquo;quiet <strong>acpi_osi=! acpi_osi=Linux acpi_osi=’Windows 2015’ pcie_port_pm=off</strong> resume=&hellip;&rdquo;</li>
<li>运行sudo update-grub，重启</li>
</ol>
<h3 id="测试显卡性能">测试显卡性能</h3>
<p>使用下面的shell命令安装显卡测试程序</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="c1"># 安装测试软件</span>
sudo pacman -S mesa-demos

<span class="c1"># 集成显卡性能</span>
glxgears -info

<span class="c1"># 独显性能</span>
optirun glxgears -info
<span class="c1"># 或者</span>
primusrun glxgears -info
</code></pre></td></tr></table>
</div>
</div><p>需要注意的是，之后运行的所有程序，如果需要使用独立显卡，需要在命令的前面加上<code>optirun</code>或者<code>primusrun</code>的前缀。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="c1"># 打开nvida面板</span>
optirun -b none nvidia-settings -c :8

<span class="c1"># 不依赖Bumblebee来使用CUDA</span>
sudo tee /proc/acpi/bbswitch <span class="o">&lt;&lt;&lt;</span> <span class="s1">&#39;ON&#39;</span>

<span class="c1"># 使用完CUDA 停止NVIDIA显卡</span>
sudo rmmod nvidia_uvm nvidia <span class="o">&amp;&amp;</span> sudo tee /proc/acpi/bbswitch <span class="o">&lt;&lt;&lt;</span> OFF

inxi -G <span class="c1"># 查看显卡情况</span>
optirun nvidia-smi <span class="c1"># 查看CPU情况</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="参考资料">参考资料</h2>
<ul>
<li><a href="https://medium.com/@joelognn/installing-tensorflow-1-6-0-gpu-on-manjaro-linux-9657fa63478" target="_blank" rel="noopener noreffer">Installing Tensorflow 1.6.0 + GPU on Manjaro Linux – Dr. Joe Logan – Medium</a></li>
<li><a href="https://www.cnblogs.com/yangruiGB2312/p/9004335.html" target="_blank" rel="noopener noreffer">Manjaro折腾笔记：我的数据科学环境搭建之路 - 杨睿 - 博客园</a></li>
<li><a href="https://leblancfg.com/installing-cuda-cudnn-tensorflow-nvidia-gtx960.html" target="_blank" rel="noopener noreffer">leblancfg.com – Notes on installing CUDA, CuDNN and Tensorflow on Manjaro</a></li>
<li><a href="https://wiki.manjaro.org/index.php/Configure_Graphics_Cards" target="_blank" rel="noopener noreffer">Configure Graphics Cards - Manjaro Linux</a></li>
</ul>]]></description>
</item></channel>
</rss>
